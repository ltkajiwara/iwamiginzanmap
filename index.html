<!DOCTYPE html>
<html>
<head>
  <title>Iwami Area Map</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Marzipano from CDN (reliable, always works) -->
  <script src="https://cdn.jsdelivr.net/npm/marzipano@0.11.0/build/marzipano.min.js"></script>

  <style>
    #map { height: 100vh; width: 100vw; }
    .marzipano-popup { width: 100%; height: 350px; background:#000; }
    @media (min-width:640px) { .marzipano-popup { height: 480px; } }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    const map = L.map('map').setView([35.108196956306735, 132.3999512741166], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: "© OpenStreetMap contributors"
    }).addTo(map);

    // ─────────────────────────────────────────────────────────────
    // 唯一変更した部分：東京駅テストマーカー → 埋め込みMarzipanoに変更
    // ─────────────────────────────────────────────────────────────
    const tokyoMarker = L.marker([35.681236, 139.767125])
      .addTo(map)
      .bindTooltip("Tokyo Station 360° Test", {
        permanent: true,
        direction: "top",
        offset: [0, -20],
        opacity: 1
      });

    tokyoMarker.bindPopup("", { maxWidth: 700 });

    tokyoMarker.on('popupopen', () => {
      const popup = tokyoMarker.getPopup();
      // すでに中身があれば何もしない（二重作成防止）
      if (popup._content && popup._content.nodeType) return;

      const container = L.DomUtil.create('div', 'marzipano-popup');

      // ここにあなたのスマホで撮った360°写真のパスを書いてください
      // 例： panoramas/my-tokyo-station.jpg
      const imageUrl = "panoramas/acropolistest.jpg";   // ← このファイル名だけ変えてね

      const viewer = new Marzipano.Viewer(container, { stage: { progressive: true } });

      const source = Marzipano.ImageUrlSource.fromString(imageUrl);
      const geometry = new Marzipano.EquirectGeometry([{ width: 8192 }]);
      const limiter = Marzipano.RectilinearView.limit.traditional(4096, 100*Math.PI/180);
      const view = new Marzipano.RectilinearView({}, limiter);

      const scene = viewer.createScene({ source, geometry, view });
      scene.switchTo();

      setTimeout(() => viewer.resize(), 150);  // ポップアップが完全に開いてからリサイズ

      popup.setContent(container);
    });
    // ─────────────────────────────────────────────────────────────

    // 以下はあなたの元のコードを1文字も変えていません（そのままコピペ）
    L.marker([35.0953231857212, 132.44456630308682])
      .addTo(map)
      .bindPopup(`
        <h3>大久保間歩</h3>
        <img src="okubo mabo.png" width="250"><br>
        <p>石見銀山でも最大の坑道であった大久保間歩の一部を見学できます（2025年7月計測）</p>
        <a href="https://my.matterport.com/show/?m=horoqkThL2i" target="_blank">Matterportで見る</a>
      `)
      .bindTooltip("大久保間歩", { permanent: true, direction: "top", offset: [0, -20], opacity: 1 });

    L.marker([35.105943422091485, 132.45192874794677])
      .addTo(map)
      .bindPopup(`
        <h3>石見銀山世界遺産センター</h3>
        <img src="iwami whc.jpg" width="200"><br>
        <p>世界遺産センターの展示室内部を見学できます（2024年12月計測）</p>
        <a href="https://my.matterport.com/show/?m=5JKWdRLs41V" target="_blank">Matterportで見る</a>
      `)
      .bindTooltip("石見銀山世界遺産センター", { permanent: true, direction: "top", offset: [0, -20], opacity: 1 });

    L.marker([35.09852345023761, 132.43903883075689])
      .addTo(map)
      .bindPopup(`
        <h3>石銀地区</h3>
        <img src="1762525465.png" width="200"><br>
        <p>仙ノ山頂上付近に位置する江戸時代の鉱山町「石銀地区」の一部を見学できます</p>
        <a href="https://my.matterport.com/show/?m=jruDkQ6CTAE" target="_blank">Matterportで見る</a>
      `)
      .bindTooltip("石銀地区", { permanent: true, direction: "top", offset: [0, -20], opacity: 1 });

    L.marker([35.09960904790995, 132.43113267470957])
      .addTo(map)
      .bindPopup(`
        <h3>栃畑谷（発掘調査地区）</h3>
        <img src="tochihatadani.png" width="200"><br>
        <p>江戸時代の製錬炉等が出土した発掘調査の現場を見学できます（2025年7月計測）</p>
        <a href="https://my.matterport.com/show/?m=FReiUj6kHRr" target="_blank">Matterportで見る</a>
      `)
      .bindTooltip("栃畑谷", { permanent: true, direction: "top", offset: [0, -20], opacity: 1 });

    L.marker([35.10540710829342, 132.43918545452155])
      .addTo(map)
      .bindPopup(`
        <h3>清水谷精錬所跡</h3>
        <img src="shimizudani.png" width="200"><br>
        <p>明治時代に造られた精錬所の遺跡「清水谷精錬所跡」を見学できます（2025
