HTML<!DOCTYPE html>
<html>
<head>
  <title>Iwami Area Map</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 100vh; width: 100vw; }
    .marzipano-popup { width: 100%; height: 400px; background:#000; }
    @media (min-width:640px) { .marzipano-popup { height: 520px; } }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marzipano@0.11.0/build/marzipano.min.js"></script>

  <script>
    const map = L.map('map').setView([35.108196956306735, 132.3999512741166], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: "© OpenStreetMap contributors"
    }).addTo(map);

    // TOKYO TEST MARKER – always shows text first, upgrades to 360° if photo exists
    const tokyoMarker = L.marker([35.681236, 139.767125])
      .addTo(map)
      .bindTooltip("360° Test", { permanent: true, direction: "top", offset: [0, -20] });

    // This text will always appear first
    tokyoMarker.bindPopup(`
      <h3>Test (Tokyo Station → Acropolis)</h3>
      <img src="tokyo station.webp" width="300"><br>
      <p>Loading 360° panorama…<br>(if nothing appears in 5 sec, photo not uploaded yet)</p>
      <div id="pano-container" style="width:100%;height:380px;background:#000;margin-top:10px;"></div>
    `, { maxWidth: 800 });

    tokyoMarker.on('popupopen', () => {
      const container = document.getElementById('pano-container');
      if (!container || container.dataset.loaded) return;

      const imageUrl = "panoramas/acropolistest.jpg";   // ← only this line matters

      // Try to load the image first – if it 404s, we keep the text
      const img = new Image();
      img.onload = () => {
        const viewer = new Marzipano.Viewer(container, { stage: { progressive: true } });
        const source = Marzipano.ImageUrlSource.fromString(imageUrl);
        const geometry = new Marzipano.EquirectGeometry([{ width: 8192 }]);
        const limiter = Marzipano.RectilinearView.limit.traditional(4096, 100*Math.PI/180);
        const view = new Marzipano.RectilinearView({ yaw: 0, pitch: 0 }, limiter);
        const scene = viewer.createScene({ source, geometry, view });
        scene.switchTo();
        setTimeout(() => viewer.resize(), 300);
        container.dataset.loaded = "true";
      };
      img.onerror = () => {
        container.innerHTML = "<p style='color:white;text-align:center;padding-top:160px;'>360° photo not found yet<br>(upload to panoramas/acropolistest.jpg)</p>";
      };
      img.src = imageUrl;
    });

    // ——————— All your original Iwami Ginzan markers below (100% untouched) ———————
    L.marker([35.0953231857212, 132.44456630308682])
      .addTo(map)
      .bindPopup(`
        <h3>大久保間歩</h3>
        <img src="okubo mabo.png" width="250"><br>
        <p>石見銀山でも最大の坑道であった大久保間歩の一部を見学できます（2025年7月計測）</p>
        <a href="https://my.matterport.com/show/?m=horoqkThL2i" target="_blank">Matterportで見る</a>
      `)
      .bindTooltip("大久保間歩", { permanent: true, direction: "top", offset: [0, -20], opacity: 1 });

    L.marker([35.105943422091485, 132.45192874794677])
      .addTo(map)
      .bindPopup(`
        <h3>石見銀山世界遺産センター</h3>
        <img src="iwami whc.jpg" width="200"><br>
        <p>世界遺産センターの展示室内部を見学できます（2024年12月計測）</p>
        <a href="https://my.matterport.com/show/?m=5JKWdRLs41V" target="_blank">Matterportで見る</a>
      `)
      .bindTooltip("石見銀山世界遺産センター", { permanent: true, direction: "top", offset: [0, -20], opacity: 1 });

    L.marker([35.09852345023761, 132.43903883075689])
      .addTo(map)
      .bindPopup(`
        <h3>石銀地区</h3>
        <img src="1762525465.png" width="200"><br>
        <p>仙ノ山頂上付近に位置する江戸時代の鉱山町「石銀地区」の一部を見学できます</p>
        <a href="https://my.matterport.com/show/?m=jruDkQ6CTAE" target="_blank">Matterportで見る</a>
      `)
      .bindTooltip("石銀地区", { permanent: true, direction: "top", offset: [0, -20], opacity: 1 });

    L.marker([35.09960904790995, 132.43113267470957])
      .addTo(map)
      .bindPopup(`
        <h3>栃畑谷（発掘調査地区）</h3>
        <img src="tochihatadani.png" width="200"><br>
        <p>江戸時代の製錬炉等が出土した発掘調査の現場を見学できます（2025年7月計測）</p>
        <a href="https://my.matterport.com/show/?m=FReiUj6kHRr" target="_blank">Matterportで見る</a>
      `)
      .bindTooltip("栃畑谷", { permanent: true, direction: "top", offset: [0, -20], opacity: 1 });

    L.marker([35.10540710829342, 132.43918545452155])
      .addTo(map)
      .bindPopup(`
        <h3>清水谷精錬所跡</h3>
        <img src="shimizudani.png" width="200"><br>
        <p>明治時代に造られた精錬所の遺跡「清水谷精錬所跡」を見学できます（2025年7月計測）</p>
        <a href="https://my.matterport.com/show/?m=E6tRvmru3P5" target="_blank">Matterportで見る</a>
      `)
      .bindTooltip("清水谷精錬所跡", { permanent: true, direction: "top", offset: [0, -20], opacity: 1 });

    L.marker([35.115349488774065, 132.44588041268344])
      .addTo(map)
      .bindPopup(`
        <h3>伝建地区「大森町」</h3>
        <img src="omoricho.jpg" width="200"><br>
        <p>江戸時代の武家屋敷や豪商の住宅など，当時の面影を良く残している「大森町」の街並みの一部を見学できます（2024年12月計測）</p>
      `)
      .bindTooltip("大森町", { permanent: true, direction: "top", offset: [0, -20], opacity: 1 });

    L.marker([35.095985785248146, 132.347967808941])
      .addTo(map)
      .bindPopup(`
        <h3>伝建地区「温泉津」</h3>
        <img src="yunotsu.png" width="200"><br>
        <p>石見銀山の外港として発展した港町「温泉津」の街並みを見学できます（2025年7月計測）</p>
      `)
      .bindTooltip("温泉津", { permanent: true, direction: "top", offset: [0, -20], opacity: 1 });

    L.marker([35.0950735, 132.4448869])
      .addTo(map)
      .bindPopup(`
        <h3>釜屋間歩</h3>
        <img src="kamaya.png" width="200"><br>
        <p>釜屋間歩における岩盤を加工したテラスや坑口，階段遺構を見学できます（2025年7月計測）</p>
        <a href="https://my.matterport.com/show/?m=zGnuNLD4WJu" target="_blank">Matterportで見る</a>
      `)
      .bindTooltip("釜屋間歩", { permanent: true, direction: "top", offset: [0, -20], opacity: 1 });

  </script>
</body>
</html>

